# Fetch Ubuntu
FROM ubuntu:18:04

# Update apt
RUN apt-get update
RUN apt-get upgrade -y

# Debian configs
COPY conf/debconf.selections /tmp/
RUN debconf-set-selections /tmp/debconf.selections

# Set ENV
ENV ALLOW_OVERRIDE All
ENV DATE_TIMEZONE UTC
ENV TERM dumb

# Prevent interactions for TZ configuration
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=Europe/Berlin
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Install standard packages
RUN apt-get install -y zip unzip git nodejs composer nano tree vim curl ftp imagemagick ffmpeg phantomjs vim

# Install php 7.0
RUN apt-get update
RUN apt-get install -y software-properties-common
RUN add-apt-repository -y ppa:ondrej/php
RUN apt-get update
RUN apt-get install -y php7.0 php7.0-bz2 php7.0-cgi php7.0-cli php7.0-common php7.0-curl php7.0-dev php7.0-enchant php7.0-fpm php7.0-gd php7.0-gmp php7.0-imap php7.0-interbase php7.0-intl php7.0-json php7.0-ldap php7.0-mbstring php7.0-mysql php7.0-odbc php7.0-opcache php7.0-pgsql php7.0-phpdbg php7.0-pspell php7.0-readline php7.0-recode php7.0-snmp php7.0-sqlite3 php7.0-sybase php7.0-tidy php7.0-xmlrpc php7.0-xsl php7.0-zip php7.0-soap php7.3-bcmath

# Install apache2
RUN apt-get install -y apache2 libapache2-mod-php7.0

# Install Mailserver
RUN apt-get install -y postfix

# Install Bower Packages
RUN apt-get install -y npm
RUN npm install -g grunt-cli less

# Relink everything
RUN a2enmod rewrite

# Set the volumes
VOLUME /var/www/html
VOLUME /var/ilias
VOLUME /var/log/httpd
VOLUME /var/lib/mysql
VOLUME /var/log/mysql
VOLUME /etc/apache2

# Copy composer script
COPY conf/composer-install.sh /var/www/
RUN chmod +x /var/www/composer-install.sh

# Make folders accessable
RUN chown -R www-data:www-data /var/www
RUN chown -R www-data:www-data /var/ilias

# Run server
COPY conf/run-lamp.sh /var/www/
RUN chmod +x /var/www/run-lamp.sh
CMD ["/var/www/run-lamp.sh"]
